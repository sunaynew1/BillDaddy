  <!doctype html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link href="output.css" rel="stylesheet">
  <link rel="preconnect" href="https://fonts.googleapis.com">

  <link rel="icon" href="favicon.png" type="image/png">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Funnel+Sans:ital,wght@0,300..800;1,300..800&display=swap" rel="stylesheet">

</head>
<body class="bg-[#222222]">
  <div class="w-full min-h-screen flex flex-col ">
   SIDEBAR
<div class="fixed top-0 left-0 h-screen w-[14%] bg-[#171717]   rounded-r-xl px-4 py-6 z-50 border-r-[0.1px] border-white/10">
  <!-- Logo -->
   <div class="flex items-center justify-center text-center mb-[45px] ">
  <i data-lucide="file-text" class="w-6 h-6 flex items-center ml-2  text-[#B6F500]"></i>
  <h1 class="text-white text-3xl font-thin font-Funnel text-center">
    Bill<span class="text-[#B6F500]">Daddy</span>
  </h1>
</div>

   
  <!-- Navigation -->
  <div class="flex flex-col gap-6 font-Funnel ">

    <!-- Generate Bill Button -->
    <a href="index.html" class="w-full p-3 rounded-xl text-black bg-[#B6F500] text-center hover:bg-[#b8f500e7] transition-all">
      + New Bill
    </a>

    <!-- Check Bills -->
    <a href="checkbill.html" class="w-full p-3 rounded-xl text-white flex items-center gap-2  hover:bg-[#B6F500] hover:text-black transition-all">
      <i data-lucide="file-text" class="w-5 h-5  hover:text-black "></i> Check Bills
    </a>

    <!-- Manage Products -->
    <a href="manageProducts.html" class="w-full p-3 rounded-xl text-white flex items-center gap-2 hover:bg-[#B6F500] hover:text-black transition-all">
      <i data-lucide="box" class="w-5 h-5"></i> Manage Products
    </a>
       <!-- Manage inventory -->
    <a href="manageInventory.html" class="w-full p-3 rounded-xl  flex items-center gap-2 hover:bg-[#B6F500] text-white hover:text-black transition-all">
      <i data-lucide="warehouse" class="w-5 h-5"></i> Manage Inventory
    </a>
    <!-- Settings -->
    <a href="#" class="w-full p-3 rounded-xl text-white flex items-center gap-2 hover:bg-[#B6F500] hover:text-black transition-all">
      <i data-lucide="settings" class="w-5 h-5"></i> Settings
    </a>

  </div>    
  </div>
<div class="ml-[6%] w-full min-h-screen  p-0 pr-0  flex items-center justify-center "> 
  
  <div class="w-full max-w-[1300px] bg-white dark:bg-[#171717] rounded-2xl shadow-2xl p-6 md:p-8 space-y-8 border-[0.1px] border-white/10">
    
    <!-- Title -->
    <h1 class="text-3xl  font-Funnel text-zinc-800 dark:text-white flex items-center gap-2">
      <i data-lucide="receipt-text" class="w-6 h-6 text-[#B6F500] dark:text-[#B6F500]"></i>
      NewBill
    </h1>

    <!-- Seller Info -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="relative">
        <label class="text-m text-zinc-600 dark:text-zinc-300 font-medium">Customer Name</label>
        <input type="text" id="CustomerName" required
          class="mt-2 w-full rounded-xl bg-zinc-100 dark:bg-zinc-800 border border-zinc-300 dark:border-zinc-700 px-4 py-2.5 text-zinc-800 dark:text-white focus:ring-2 focus:ring-[#B6F500] focus:outline-none transition" />
        <ul id="retailer-suggestion"
          class="hidden absolute left-0 right-0 mt-1 bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-700 rounded-xl shadow-md z-50 text-sm text-zinc-800 dark:text-white max-h-60 overflow-y-auto ring-1 ring-black/5"></ul>
      </div>

      <div>
        <label class="text-sm text-zinc-600 dark:text-zinc-300 font-medium">Contact Number</label>
        <input type="text" id="ContactNumber"
          class="mt-2 w-full rounded-xl bg-zinc-100 dark:bg-zinc-800 border border-zinc-300 dark:border-zinc-700 px-4 py-2.5 text-zinc-800 dark:text-white focus:ring-2 focus:ring-[#B6F500] focus:outline-none transition" />
      </div>

      <div>
        <label class="text-sm text-zinc-600 dark:text-zinc-300 font-medium">GST Number</label>
        <input type="text" id="GSTNumber"
          class="mt-2 w-full rounded-xl bg-zinc-100 dark:bg-zinc-800 border border-zinc-300 dark:border-zinc-700 px-4 py-2.5 text-zinc-800 dark:text-white focus:ring-2 focus:ring-[#B6F500] focus:outline-none transition" />
      </div>

      <div>
        <label class="text-sm text-zinc-600 dark:text-zinc-300 font-medium">Address</label>
        <input type="text" id="address"
          class="mt-2 w-full rounded-xl bg-zinc-100 dark:bg-zinc-800 border border-zinc-300 dark:border-zinc-700 px-4 py-2.5 text-zinc-800 dark:text-white focus:ring-2 focus:ring-[#B6F500] focus:outline-none transition" />
      </div>

      <div>
        <label class="text-sm text-zinc-600 dark:text-zinc-300 font-medium">Payment Method</label>
        <select id="PaymentMethod"
          class="mt-2 w-full rounded-xl bg-zinc-100 dark:bg-zinc-800 border border-zinc-300 dark:border-zinc-700 px-4 py-2.5 text-zinc-800 dark:text-white focus:ring-2 focus:ring-[#B6F500] focus:outline-none transition">
          <option value="cash">Cash</option>
          <option value="online">Online</option>
        </select>
      </div>
    </div>

    <!-- Products -->
    <div class="space-y-6">
      <h2 class="text-xl font-semibold text-zinc-800 dark:text-white flex items-center gap-2">
        <i data-lucide="package" class="w-5 h-5 text-[#B6F500] dark:text-[#F4631E]"></i>
        Products
      </h2>

    <!-- Column Labels -->
<div class="hidden md:flex items-center gap-3 text-sm font-semibold text-zinc-500 dark:text-zinc-300 px-2 py-2">
  <div class="flex-1 min-w-[200px]">Product Name</div>
  <div class="w-20">Qty</div>
  <div class="w-24">Metric</div>
  <div class="w-24">Stock</div>
  <div class="w-24">Landing</div>
  <div class="w-24">MRP</div>
  <div class="w-24">Price</div>
  <div class="w-28">Amount</div>
  <div class="w-auto">Clear</div>
</div>


      <!-- Product list -->
      <div id="product-list" class="space-y-6"></div>

      <!-- Add Button -->
      <button id="add-product"
        class="flex items-center gap-2 text-sm px-4 py-2 bg-[#F4631E] hover:bg-[#F4631E] text-white font-medium rounded-xl transition">
        <i data-lucide="plus" class="w-4 h-4"></i> Add Product
      </button>
    </div>

    <!-- Totals Section -->
    <div class="border-t border-dashed border-zinc-300 dark:border-zinc-700 pt-6 grid grid-cols-1 md:grid-cols-6 gap-6 text-sm">
      <div>
        <label class="text-zinc-600 dark:text-zinc-300 font-medium">Sub Total</label>
        <input type="number" id="subTotal" disabled
          class="mt-2 w-full rounded-xl bg-zinc-100 dark:bg-zinc-800 border border-zinc-300 dark:border-zinc-700 px-4 py-2.5 text-zinc-800 dark:text-white focus:outline-none" placeholder="0" />
      </div>


      <div>
        <label class="text-zinc-600 dark:text-zinc-300 font-medium">Discount (₹)</label>
        <input type="number" id="discount"
          class="mt-2 w-full rounded-xl bg-zinc-100 dark:bg-zinc-800 border border-zinc-300 dark:border-zinc-700 px-4 py-2.5 text-zinc-800 dark:text-white focus:outline-none" placeholder="0" />
      </div>

      <div>
        <label class="text-zinc-600 dark:text-zinc-300 font-medium">Round Off (₹)</label>
        <input type="number" id="roundOff"
          class="mt-2 w-full rounded-xl bg-zinc-100 dark:bg-zinc-800 border border-zinc-300 dark:border-zinc-700 px-4 py-2.5 text-zinc-800 dark:text-white focus:outline-none" placeholder="0" />
      </div>

      <div>
        <label class="text-zinc-600 dark:text-zinc-300 font-medium">Total Amount (₹)</label>
        <input type="text" id="total-amount" readonly
          class="mt-2 w-full rounded-xl bg-zinc-200 dark:bg-zinc-700 border border-zinc-300 dark:border-zinc-700 px-4 py-2.5 text-zinc-900 dark:text-white focus:outline-none" placeholder="0" />
      </div>
    </div>

    <!-- Submit Button -->
    <div class="pt-4 text-right">
      <button id="submit"
        class="inline-flex items-center gap-2 px-6 py-2 bg-[#B6F500] hover:bg-[#B6F500]/90 text-black rounded-xl transition font-medium">
        <i data-lucide="receipt-text" class="w-4 h-4"></i>
        Generate
      </button>
    </div>
    
  </div>
</div>


  </div>
    <!-- Toast Notification -->
  <div id="toast" class="hidden">
    <div id="toastIcon"></div>
    <span id="toastText" class="text-sm font-medium">Message</span>
  </div>
    <!-- Loading Overlay -->
  <div id="loadingPopup" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50">
    <div class="bg-black text-white px-6 py-4 rounded-2xl shadow-2xl flex items-center space-x-3">
      <svg class="animate-spin h-9 w-9 text-[#B6F500]" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
      </svg>
      <span class="text-lg font-large">Loading, please wait...</span>
    </div>
  </div>
  
  <script src="https://unpkg.com/lucide@latest">
    
  </script>   
  <script>lucide.createIcons();</script>
  <script src="loading.js"></script>

  <script type="module" >
     showLoading()
     await  fetchRetailerData()
     await fetchProductData()
     hideLoading() 
      lucide.createIcons();
    

      
    let allProducts = JSON.parse(localStorage.getItem("products"));
    let allRetailers =JSON.parse(localStorage.getItem("Retailers"));
    console.log(allRetailers)
    let SubTotalAmount=0
    let TotalAmount;


    async function invoice(){
    const CurrentInvoiceNo = await CurrentInvoiceNumber() 
    console.log(`invoice no:-${CurrentInvoiceNo}`)
    }

    invoice()
    
    let itemArray = []

    let AvailableStock;
    function newItem(){
      
      let itemNo = itemArray.length+1
      let itemID = `item-${itemNo}`
      const productFields = `
<div id='${itemID}-id' class="border-t border-dashed border-zinc-300 dark:border-zinc-700 py-4 product-item">
  <div class="flex flex-wrap lg:flex-nowrap items-center gap-3 ">

    <!-- Product Name (with relative positioning for dropdown) -->
    <div class="flex-1 min-w-[200px] relative">
      <input
        type="text"
        id="${itemID}-name"
        placeholder="Product Name"
        class="w-full rounded-xl bg-zinc-100 dark:bg-zinc-800 border border-zinc-300 dark:border-zinc-600 px-4 py-2.5 text-sm text-zinc-900 dark:text-white focus:ring-2 focus:ring-[#F4631E] focus:outline-none transition"
      />
      <ul
        id="${itemID}-suggestion"
        class="suggestions hidden absolute left-0 right-0 top-full mt-1 bg-white dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-700 rounded-xl shadow-lg z-50 text-sm text-zinc-800 dark:text-white max-h-60 overflow-y-auto"
      ></ul>
    </div>

    <!-- Quantity -->
    <input
      type="number"
      id="${itemID}-qty"
      placeholder="Qty"
      min="1"
      class="w-20 rounded-xl bg-zinc-100 dark:bg-zinc-800 border border-zinc-300 dark:border-zinc-600 px-3 py-2.5 text-sm text-zinc-900 dark:text-white focus:ring-2 focus:ring-[#F4631E] focus:outline-none transition"
    />

    <!-- Metric -->
    <select
      id="${itemID}-metric"
      class="w-24 rounded-xl bg-zinc-100 dark:bg-zinc-800 border border-zinc-300 dark:border-zinc-600 px-2 py-2.5 text-sm text-zinc-900 dark:text-white focus:ring-2 focus:ring-[#F4631E] focus:outline-none transition"
    >
      <option value="Pcs" selected>Pcs</option>
      <option value="gm">gm</option>
      <option value="Kg">Kg</option>
      <option value="ml">ml</option>
      <option value="ltr">ltr</option>
    </select>

    <!-- Stock -->
    <input
      type="number"
      id="${itemID}-stock"
      placeholder="Stock"
      min="1"
      disabled
      class="w-24 rounded-xl bg-zinc-100 dark:bg-zinc-800 border border-zinc-300 dark:border-zinc-600 px-3 py-2.5 text-sm text-zinc-900 dark:text-white focus:outline-none transition"
    />
 <!-- Landing -->
    <input
      type="number"
      id="${itemID}-Landing"
      placeholder="Landing"
      class="w-24 rounded-xl bg-zinc-100 dark:bg-zinc-800 border border-zinc-300 dark:border-zinc-600 px-3 py-2.5 text-sm text-zinc-900 dark:text-white focus:outline-none transition"
    />

    <!-- MRP -->
    <input
      type="number"
      id="${itemID}-MRP"
      placeholder="MRP"
      class="w-24 rounded-xl bg-zinc-100 dark:bg-zinc-800 border border-zinc-300 dark:border-zinc-600 px-3 py-2.5 text-sm text-zinc-900 dark:text-white focus:outline-none transition"
    />

    <!-- Price -->
    <input
      type="number"
      id="${itemID}-Price"
      placeholder="Price"
      class="w-24 rounded-xl bg-zinc-100 dark:bg-zinc-800 border border-zinc-300 dark:border-zinc-600 px-3 py-2.5 text-sm text-zinc-900 dark:text-white focus:outline-none transition"
    />

    <!-- Amount -->
    <input
      type="number"
      id="${itemID}-ammount"
      placeholder="Amount"
      disabled
      class="w-28 rounded-xl bg-zinc-100 dark:bg-zinc-800 border border-zinc-300 dark:border-zinc-600 px-3 py-2.5 text-sm text-zinc-900 dark:text-white focus:outline-none transition"
    />

    <!-- Clear Button -->
    <button
      id="${itemID}-clear"
      class="text-sm text-red-600 hover:text-red-700 font-semibold tracking-wide px-2"
    >
      CLEAR
    </button>
  </div>
</div>

  
        `;
        itemArray.push(itemID)
        document.getElementById("product-list").insertAdjacentHTML("beforeend", productFields);

          document.getElementById(`${itemID}-clear`).addEventListener("click" , () => {
             let productName = document.getElementById(`${itemID}-name`)
        let productMRP = document.getElementById(`${itemID}-MRP`)
        let productPRICE = document.getElementById(`${itemID}-Price`)
        let productQuantity = document.getElementById(`${itemID}-qty`)
        let productStockQty = document.getElementById(`${itemID}-stock`)
        let productAmount = document.getElementById(`${itemID}-ammount`)
        let subTotal = document.getElementById("subTotal")
        let productId = document.getElementById(`${itemID}-id`)
        let productMetric = document.getElementById(`${itemID}-metric`)

        productName.value=""
           productMRP.value=""
              productPRICE.value=""
                 productStockQty.value=""
                    productQuantity.value=""
                         productAmount.value=""
            
           })

        document.getElementById(`${itemID}-qty`).addEventListener("input" , async (e) => {
          
         
          let qty = e.target.value.trim()
          
          let metric = document.getElementById(`${itemID}-metric`).value
          // if(metric != "gm" && metric!= "Kg"){
            document.getElementById(`${itemID}-ammount`).value=qty*(document.getElementById(`${itemID}-Price`).value)
           if(AvailableStock != 0) {
            document.getElementById(`${itemID}-stock`).value= AvailableStock - qty
           }
           
          // }
         console.log(qty)
          // if(qty<=AvailableStock){
          // document.getElementById(`${itemID}-stock`).value= AvailableStock - qty
          // }else{
          //   qty=AvailableStock
          //   // window.alert("You Are Choosing more quantity than present in your Inventory")
          //   window.alert("You Are Choosing more quantity than present in your Inventory")
          //   document.getElementById(`${itemID}-qty`).value=AvailableStock

            
          // }
          
          // doSubTotal()
          // addTotal(productAmount)
      
        })
       productSuggestions()
    }
     

        document.addEventListener("DOMContentLoaded", newItem())


          function createSuggestionItem(productName,productMRP,productPRICE,productQuantity,productAmount,subTotal,productStockQty,productId,prodMetric,prodName,prodMRP,prodPrice,stockqty,id,metric, ul) {
    const li = document.createElement("li");
    // li.id=text
    li.textContent = prodName;
    li.className = "suggestionItem px-4 py-2 cursor-pointer hover:bg-zinc-100 dark:hover:bg-zinc-800";
    
    li.onclick = () => {
      productId.dataset.userId=id
      productName.value = prodName;
      productMRP.value = prodMRP
      productPRICE.value = prodPrice
      productQuantity.value=1
      
      productAmount.value=(productQuantity.value)*(productPRICE.value)
      if(stockqty != 0){
        productStockQty.value=stockqty - productQuantity.value
      AvailableStock= stockqty
      }
     
      
      doSubTotal()
      ul.classList.add("hidden");
    };
    return li;
  }
  

          function productSuggestions(){
      itemArray.forEach(item =>{
        console.log(item)
        let productName = document.getElementById(`${item}-name`)
        let productMRP = document.getElementById(`${item}-MRP`)
        let productPRICE = document.getElementById(`${item}-Price`)
        let productQuantity = document.getElementById(`${item}-qty`)
        let productStockQty = document.getElementById(`${item}-stock`)
        let productAmount = document.getElementById(`${item}-ammount`)
        let subTotal = document.getElementById("subTotal")
        let productId = document.getElementById(`${item}-id`)
        let productMetric = document.getElementById(`${item}-metric`)

        productName.addEventListener("input",(e) => {
          let name = e.target.value.trim()
       const ul= document.getElementById(`${item}-suggestion`)

           ul.innerHTML=""

              
    if (name.length === 0) {
      ul.classList.add("hidden");
      return;
    }else{
      ul.classList.remove("hidden");
    }
          
          console.log(name)

          try{

           const regex = new RegExp(name,"i")
         const matched = allProducts.filter(p => regex.test(p.productName))
         console.log(matched)

           if (matched.length === 0) {
        ul.classList.add("hidden");
        return;
      }
       matched.forEach(match =>{
 
         ul.appendChild(createSuggestionItem(productName,productMRP,productPRICE,productQuantity,productAmount,subTotal,productStockQty,productId,productMetric,match.productName,match.MRP,match.PRICE,match.CurrentStock,match._id, match.productMetric,ul));
          ul.classList.remove("hidden");
        })

        document.addEventListener("click",(e) => {

          ul.classList.add("hidden");
        })
              
        productMetric.addEventListener("input", (e)=> {
          
          let metric =  e.target.value
          console.log(metric)
           if(metric == "Pcs" || metric == "gm"  || metric == "Kg"){
            productAmount.value=productQuantity.value*(productPRICE.value)         
            doSubTotal()
            }else{
              console.log("same value")
              productStockQty.value="Stock Available"
              productAmount.value=productPRICE.value
              doSubTotal()
            }
        })
       

        productPRICE.addEventListener("input",(e) =>{
             console.log("price calculation",productMetric.value)
            let price = e.target.value.trim()
            if(productMetric.value == "Pcs" ){
            productAmount.value=productQuantity.value*(productPRICE.value)         
            doSubTotal()
            }else{
              productAmount.value=productPRICE.value
              doSubTotal()
            }
             
        })
         
        }catch(error){
          console.log(error)
        }
        
        })
      
       
      })
    }

    function createRetailerSuggestionList(retailerNameLocation,retailerContactLocation,retailerGSTLocation,retailerAddressLocation,CustomerName,ContactNumber,GSTNumber,Address,ul){
      
      const li = document.createElement("li")
      li.textContent=CustomerName
      li.className = " px-4 py-2 cursor-pointer hover:bg-zinc-100 dark:hover:bg-zinc-800"
      li.onclick = () => {
        retailerNameLocation.value=CustomerName
        retailerContactLocation.value=ContactNumber
        retailerGSTLocation.value=GSTNumber
        retailerAddressLocation.value=Address
        ul.classList.add("hidden");
      }    
      return li;
    }
      
    function RetailerSuggestion(){
      let retailerNameLocation = document.getElementById("CustomerName")
      let retailerContactLocation = document.getElementById("ContactNumber")
      let retailerGSTLocation = document.getElementById("GSTNumber")
      let retailerAddressLocation = document.getElementById("address")

      retailerNameLocation.addEventListener("input" , (e) =>{
        let name = e.target.value.trim()
        let ul = document.getElementById("retailer-suggestion")

        ul.innerHTML=""

        if(name == ""){
          ul.classList.add("hidden")
          return;
        }else{
           ul.classList.remove("hidden")
        }

        // console.log(name)

        try{
          const regex = new RegExp(name,"i")
          const matched = allRetailers.filter(r => regex.test(r.CustomerName))
          // console.log(matched)
          console.log(matched)
        
          if(matched.length === 0 ){
            ul.classList.add("hidden")
            return;
          }else{
             ul.classList.remove("hidden")
          }

          matched.forEach(match =>{
             ul.appendChild(createRetailerSuggestionList(retailerNameLocation,retailerContactLocation,retailerGSTLocation,retailerAddressLocation,match.CustomerName,match.ContactNumber,match.GSTNumber,match.Address,ul))
          ul.classList.remove("hidden")

          document.addEventListener("click",()=> {
             ul.classList.add("hidden")
          })

        })
            }catch(error){
          console.log(error)
        }
      })
    }
     
    RetailerSuggestion()

    document.getElementById("add-product").addEventListener("click", () => {
      AvailableStock=0
      newItem()


    });

 


document.getElementById("submit").addEventListener("click", async () => {
  doSubTotal()
  let CustomerName=document.getElementById("CustomerName").value
  let retailerContactNumber = document.getElementById("ContactNumber").value
  // console.log(retailerContactNumber)
  let retailerGSTNumber= GSTNumber.value
  let retaileraddress =address.value
  let paymentMethod= PaymentMethod.value
 
  let subTotal = document.getElementById("subTotal").value
  let FinalTotal =document.getElementById("total-amount").value
  let round = document.getElementById("roundOff").value
  let Order ;
  let itemsList = []
  let productUpdateList =[]
  itemArray.forEach(item =>{
 let productName = document.getElementById(`${item}-name`).value
        let productMRP = document.getElementById(`${item}-MRP`).value
        let productPRICE = document.getElementById(`${item}-Price`).value
        let productQuantity = document.getElementById(`${item}-qty`).value
        let productAmount = document.getElementById(`${item}-ammount`).value
        let productId = document.getElementById(`${item}-id`)
        let productMetric = document.getElementById(`${item}-metric`).value
       

      itemsList.push({
          productName,
          productMRP,
          productQuantity,
          productPRICE,
          productAmount,
          productMetric
      })
  })

if(!CustomerName || !retailerContactNumber || !retailerGSTNumber || !retaileraddress){
    if(CustomerName==""){
        CustomerName = "CASH"
       

    }
     if(retailerContactNumber==""){
        retailerContactNumber="None"
    }

    if(retaileraddress == ""){
      retaileraddress="None"
    }

}

if(FinalTotal == "NaN"){
    console.log("Please add product first")
}else{
    let newArray =[];
    itemArray.forEach(item =>{
        let productName = document.getElementById(`${item}-name`).value
          if(productName != ""){
            let productMRP = document.getElementById(`${item}-MRP`).value
            let productPRICE = document.getElementById(`${item}-Price`).value
            let productQuantity = document.getElementById(`${item}-qty`).value
            let productAmount = document.getElementById(`${item}-ammount`).value
            let productId = document.getElementById(`${item}-id`).dataset.userId
            let productMetric = document.getElementById(`${item}-metric`).value
            productUpdateList.push({
              productId:productId,
              newStock:document.getElementById(`${item}-stock`).value
            })
            newArray.push({
          productName,
          productMRP,
          productQuantity,
          productPRICE,
          productMetric,
          productAmount   
            })
          }
    })
    if(newArray.length != 0){
     Order = {
    CustomerName :CustomerName,
    retailerContactNumber:retailerContactNumber,
    retailerGSTNumber:retailerGSTNumber,
    retaileraddress:retaileraddress,
    paymentMethod:paymentMethod,  
    items:newArray,
    SubTotal:subTotal,
    
    roundOff:round,
    TotalAmount:FinalTotal,
  }

  console.log(Order)
   await checkProductAndAdd(newArray)
 await updateAvailableStock(productUpdateList)
  await generateBill(Order)
  // let findRetailer = allRetailers.find(retailer => retailer.CustomerName == CustomerName)
  // if(findRetailer!=true){
  await newRetailer(CustomerName,retailerContactNumber,retailerGSTNumber,retaileraddress)
  // }
 
 
  
  let invoice = await CurrentInvoiceNumber()
  

  console.log(invoice)
 const bill2 = window.open(`https://bill-daddy-eight.vercel.app/bill2.html?I=${invoice}`, "_blank");
    const bill3 = window.open(`https://bill-daddy-eight.vercel.app/bill3.html?I=${invoice}`, "_blank");

    // Only reload if both tabs successfully opened
    if (bill2 && bill3) {
      window.location.reload();
    } else {
      alert("Please allow popups for this site in your browser.");
    }
  }
}
})
 
  // window.location.href=`k.html/${CurrentInvoiceNo}`



function doSubTotal(){
    // console.log(itemArray)
   SubTotalAmount=0
  itemArray.forEach(item=>{
     
    let check = document.getElementById(`${item}-ammount`).value
    console.log(`check value ${check} checksasasas type : ${typeof(check)}`)
    if(check === NaN || check === "NaN" || check == ""){
      console.log("skipping NaN")
    showToast("error", "Add Items First!!!")

    }else{
        let productAmount = parseInt(document.getElementById(`${item}-ammount`).value)
                SubTotalAmount=SubTotalAmount+productAmount
   
    TotalAmount=SubTotalAmount 
     document.getElementById("subTotal").value=SubTotalAmount
     let x=((Math.round(TotalAmount)-(TotalAmount)))
     let roundOff = x.toFixed(2)
    document.getElementById("roundOff").value=roundOff
      
    document.getElementById("total-amount").value=Math.round(TotalAmount)
    console.log(Math.round(TotalAmount))
    }
       
  })
}



    async function fetchProductData() {
      try {
        const req = await fetch("https://billdaddy-production.up.railway.app/api/v1/users/fetchProductData", {
          method: "GET"

        })
        const data = await req.json()
        const d = data.data
      if (data.message == "success") {
         d.sort((a, b) => {
          return a.productName.localeCompare(b.productName);
        });
        // console.log(d)
        localStorage.setItem("products", JSON.stringify(d));
        
       await showToast("success", "Successfully Fetched Product Data");
       return data;
      }else{
        showToast("error", "Request failed: " + data.message);
      }

       
      } catch (error) {
        console.log(`error occured while fetching data : - ${error}`)
      }
    }

        async function fetchRetailerData() {
      try {
        const req = await fetch("https://billdaddy-production.up.railway.app/api/v1/users/fetchRetailers", {
          method: "GET",
        })
        const data = await req.json()
        const d = data.data
        d.sort((a, b) => {
          return a.CustomerName.localeCompare(b.CustomerName);
        });
        // console.log(d)
        localStorage.setItem("Retailers", JSON.stringify(d));
        return data;
      } catch (error) {
        console.log(`error occured while fetching data : - ${error}`)
      }
    }

    async function generateBill(Order){
      try{
        const req = await fetch("https://billdaddy-production.up.railway.app/api/v1/users/generateBill ",{
          method:"POST",
          headers:{
            "Content-Type" : "application/json"
          },
          body:JSON.stringify({Order})
        })
         
        const data = await req.json()
        console.log(data.message)
        if(data.message == "success"){
           showToast("success", "Successfully Generated Bill");
        }else{
          await showToast("error", "Request failed: " + err.message);
        }
      }catch(error){
        console.log(error)
      }
    }

    async function CurrentInvoiceNumber(){
      try{
        const req = await fetch("https://billdaddy-production.up.railway.app/api/v1/users/invoiceNo",{
          method:"POST",
          headers:{
            "Content-Type" : "application/json"
          }
        })
        const data = await req.json()
        console.log(data.data)
        return data.data

      }catch(error){
        console.log(error)
      }
    }

   async function updateAvailableStock(newAvailableStock){
      console.log(newAvailableStock)
      try{
        let req = await fetch("https://billdaddy-production.up.railway.app/api/v1/users/updateAvailableStock" , {
           method:"POST",
           headers:{
            "Content-Type":"application/json"
           },
           body:JSON.stringify({newAvailableStock})
        })
        const data = await req.json()
        console.log(data.message)
        if(data.message == "success"){
           showToast("success", "Successfully updated");
        }
        
      }catch(error){
        console.log(error)
      }
    }

    async function newRetailer(CustomerName,retailerContactNumber,retailerGSTNumber,retaileraddress){
      try{
        const req = await fetch("https://billdaddy-production.up.railway.app/api/v1/users/addRetailer" , {
          method:"POST",
          headers:{
            "Content-Type": "application/json"
          },  
          body: JSON.stringify({CustomerName,retailerContactNumber,retailerGSTNumber,retaileraddress})
        })
        const data = await req.json()
        console.log(data)
        localStorage.removeItem("Retailers")
       await fetchRetailerData()
      }catch(error){
        console.log(error)
      }
    }

    async function checkProductAndAdd (items){
      try{
        const req = await fetch("https://billdaddy-production.up.railway.app/api/v1/users/checkProductAndAdd" , {
          method:"POST",
          headers:{
          "Content-Type":"application/json"
          },
          body:JSON.stringify({items})
        }) 
        let data = await req.json()
        await showToast("success", data.message)
      }catch(error){
        console.log(error)
      }
    }
   </script>
  </script>
</body>
</html>
